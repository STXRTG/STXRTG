document.addEventListener('DOMContentLoaded', () => {    const totalPlayersEl = document.getElementById('totalPlayers');    const totalModsEl = document.getElementById('totalMods');    const livePlayersEl = document.getElementById('livePlayers');    const modListEl = document.getElementById('modList');    const btnGuestView = document.getElementById('btnGuestView');    const btnAdminView = document.getElementById('btnAdminView');    const adminElements = document.querySelectorAll('.admin-only');    const tableTitle = document.getElementById('tableTitle');    const mainContent = document.querySelector('.main-content');    const userRoleBadge = document.getElementById('userRoleBadge');    const adminDauEl = document.getElementById('adminDau');    const adminPingsEl = document.getElementById('adminPings');    const adminDauTrendEl = document.getElementById('adminDauTrend');    let isAdminView = false;    let latestData = null;     const loginModal = document.getElementById('loginModal');    const btnCloseModal = document.getElementById('btnCloseModal');    const btnCancelLogin = document.getElementById('btnCancelLogin');    const btnSubmitLogin = document.getElementById('btnSubmitLogin');    const adminPasswordInput = document.getElementById('adminPassword');    const loginError = document.getElementById('loginError');    function toggleView(isAdmin) {        isAdminView = isAdmin;        if (isAdmin) {            btnAdminView.classList.add('active');            btnGuestView.classList.remove('active');            mainContent.classList.remove('guest-view');            tableTitle.innerText = "Detailed Analytics (24H Segmented)";            userRoleBadge.innerText = "Admin_User";            adminElements.forEach(el => el.classList.remove('hidden'));        } else {            btnGuestView.classList.add('active');            btnAdminView.classList.remove('active');            mainContent.classList.add('guest-view');            tableTitle.innerText = "Workspace Telemetry Breakdown";            userRoleBadge.innerText = "Guest_User";            adminElements.forEach(el => el.classList.add('hidden'));        }        if (latestData) renderUI(latestData);    }    function showLoginModal() {        if (isAdminView) return;         loginModal.classList.remove('hidden');        adminPasswordInput.value = '';        loginError.classList.add('hidden');        adminPasswordInput.focus();    }    function hideLoginModal() {        loginModal.classList.add('hidden');    }    async function attemptLogin() {        const password = adminPasswordInput.value;        if (!password) return;        btnSubmitLogin.disabled = true;        btnSubmitLogin.innerText = 'Verifying...';        try {            const response = await fetch('/api/login', {                method: 'POST',                headers: { 'Content-Type': 'application/json' },                body: JSON.stringify({ password })            });            const result = await response.json();            if (result.success) {                hideLoginModal();                toggleView(true);            } else {                loginError.innerText = result.error || 'Invalid password.';                loginError.classList.remove('hidden');            }        } catch (error) {            loginError.innerText = 'Error connecting to server.';            loginError.classList.remove('hidden');        } finally {            btnSubmitLogin.disabled = false;            btnSubmitLogin.innerText = 'Authorize';        }    }    btnGuestView.addEventListener('click', (e) => { e.preventDefault(); toggleView(false); });    btnAdminView.addEventListener('click', (e) => {        e.preventDefault();        showLoginModal();    });    btnCloseModal.addEventListener('click', hideLoginModal);    btnCancelLogin.addEventListener('click', hideLoginModal);    btnSubmitLogin.addEventListener('click', attemptLogin);    adminPasswordInput.addEventListener('keypress', (e) => {        if (e.key === 'Enter') attemptLogin();    });    function animateValue(obj, start, end, duration) {        let startTimestamp = null;        const step = (timestamp) => {            if (!startTimestamp) startTimestamp = timestamp;            const progress = Math.min((timestamp - startTimestamp) / duration, 1);            obj.innerHTML = Math.floor(progress * (end - start) + start);            if (progress < 1) {                window.requestAnimationFrame(step);            } else {                obj.innerHTML = end;            }        };        window.requestAnimationFrame(step);    }    function renderUI(data) {        const modNames = data.mods ? Object.keys(data.mods) : [];        if (data.total_unique_players === 0) {            totalPlayersEl.innerText = "-";            totalModsEl.innerText = "-";            livePlayersEl.innerText = "-";            if (isAdminView) {                adminDauEl.innerText = "-";                adminPingsEl.innerText = "-";                adminDauTrendEl.className = 'kpi-trend positive';                adminDauTrendEl.querySelector('.trend-text').innerText = `vs previous 24h`;            }        } else {            const currentTotal = parseInt(totalPlayersEl.innerText) || 0;            animateValue(totalPlayersEl, currentTotal, data.total_unique_players, 800);            const currentModsCount = parseInt(totalModsEl.innerText) || 0;            animateValue(totalModsEl, currentModsCount, modNames.length, 800);            const currentLive = parseInt(livePlayersEl.innerText) || 0;            animateValue(livePlayersEl, currentLive, data.live_players, 800);            if (isAdminView) {                const currentDau = parseInt(adminDauEl.innerText) || 0;                animateValue(adminDauEl, currentDau, data.daily_active_users, 800);                const currentPings = parseInt(adminPingsEl.innerText) || 0;                animateValue(adminPingsEl, currentPings, data.total_pings_24h, 800);                if (data.dau_trend_pct === 0) {                    adminDauTrendEl.className = 'kpi-trend neutral';                    adminDauTrendEl.querySelector('.trend-text').innerText = `0% vs previous 24h`;                } else {                    adminDauTrendEl.className = 'kpi-trend ' + (data.dau_trend_pct > 0 ? 'positive' : 'negative');                    adminDauTrendEl.querySelector('.trend-text').innerText = `${data.dau_trend_pct > 0 ? '+' : ''}${data.dau_trend_pct}% vs previous 24h`;                }            }        }        let maxUses = 0;        modNames.forEach(mod => {            if (data.mods[mod].total > maxUses) maxUses = data.mods[mod].total;        });        modListEl.innerHTML = '';        if (modNames.length === 0) {            modListEl.innerHTML = '<div class="loading-state"><span>No telemetry streams detected.</span></div>';            return;        }        modNames.sort((a, b) => data.mods[b].total - data.mods[a].total);        modNames.forEach((mod, index) => {            const count = data.mods[mod].total;            const active24h = data.mods[mod].active_24h;            const percentage = maxUses === 0 ? 0 : (count / maxUses) * 100;            const modItem = document.createElement('div');            modItem.className = 'table-row';            modItem.style.opacity = '0';            modItem.style.transform = 'translateY(10px)';            modItem.style.transition = 'opacity 0.4s ease, transform 0.4s ease';            let rowHtml = `                <div class="cell-name">                    <div class="mod-icon">                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>                    </div>                    <span>${mod}</span>                </div>                <div class="cell-usage">                    <div class="usage-track">                        <div class="usage-fill" style="width: 0%"></div>                    </div>                    <span class="usage-pct">${Math.round(percentage)}%</span>                </div>            `;            if (isAdminView) {                rowHtml += `<div class="cell-24h admin-only">+${active24h.toLocaleString()}</div>`;            } else {                rowHtml += `<div class="cell-24h admin-only hidden">+${active24h.toLocaleString()}</div>`;            }            rowHtml += `<div class="cell-count">${count.toLocaleString()}</div>`;            modItem.innerHTML = rowHtml;            modListEl.appendChild(modItem);            setTimeout(() => {                modItem.style.opacity = '1';                modItem.style.transform = 'translateY(0)';                const fill = modItem.querySelector('.usage-fill');                setTimeout(() => {                    fill.style.width = `${percentage}%`;                }, 50);            }, index * 50);        });    }    async function fetchStats() {        try {            const response = await fetch('/api/stats');            latestData = await response.json();            renderUI(latestData);        } catch (error) {            console.error('Failed to fetch stats:', error);            totalPlayersEl.innerText = "--";            if (isAdminView) { adminDauEl.innerText = "--"; adminPingsEl.innerText = "--"; }            modListEl.innerHTML = '<div class="loading-state"><span style="color: #ef4444;">Error connecting to Telemetry API</span></div>';        }    }    toggleView(false);    fetchStats();});